!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.CustomJson2excel=e():t.CustomJson2excel=e()}(globalThis,()=>(()=>{"use strict";var t={};t.d=function(e,o){for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},t.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},t.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var e={};t.r(e),t.d(e,{default:()=>n});let o=Object.prototype.toString;function r(t,e){return o.call(t)===`[object ${e}]`}function s(t){return null!==t&&r(t,"Object")}class n{data;scope;orderedKey;filters;title;footer;keyMap;name;type;onStart;onSuccess;onError;constructor({data:t=[],scope:e={},orderedKey:o=[],filters:r=[],title:s=[],footer:n=[],keyMap:l={},name:i="excel",type:a="xls",onStart:h=()=>{},onSuccess:c=()=>{},onError:f=t=>{console.log(t)}}){this.data=t,this.scope=e,this.filters=r,this.footer=n,this.orderedKey=o,this.keyMap=l,this.name=i,this.title=s,this.type=a,this.onStart=h,this.onSuccess=c,this.onError=f}generate(){if(!this.data||!this.data.length){this.onError&&this.onError();return}this.onStart&&this.onStart();let t=this.getProcessedJson(this.data);return(t=this.toChsKeys(t),"csv"==this.type)?this.export(this.jsonToCSV(t),`${this.name}.${this.type}`,"application/csv"):this.export(this.jsonToXLS(t),`${this.name}.${this.type}`,"application/vnd.ms-excel")}getObjLastValue(t,e){if(s(e)){let o=Object.keys(e)[0],r=Object.values(e)[0];return this.getObjLastValue(t[o],r)}return t[e]}toChsKeys(t){return t.map(t=>{let e={};if(this.orderedKey&&this.orderedKey.length)for(let o of this.orderedKey)e[o]=t[o];if(this.filters&&this.filters.length)for(let t of this.filters)delete e[t];if(this.scope&&Object.keys(this.scope).length){let o=Object.keys(e).length?e:t;for(let t in o)this.scope.hasOwnProperty(t)?e[t]=this.getObjLastValue(o[t],this.scope[t]):e[t]=o[t]}if(this.keyMap&&Object.keys(this.keyMap).length){let o=Object.keys(e).length?e:t;for(let t in o)this.keyMap.hasOwnProperty(t)&&(e[this.keyMap[t]]=o[t],delete o[t])}return Object.keys(e).length?e:t})}download(t,e){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(t,e);else{let o=document.createElement("a"),r=window.URL.createObjectURL(t);o.href=r,o.setAttribute("download",e),o.innerHTML="downloading...",o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),document.body.removeChild(o),setTimeout(()=>{self.URL.revokeObjectURL(o.href)},250)},66)}}export(t,e,o){new Promise(r=>{let s=this.base64ToBlob(t,o);r(this.download(s,e))}).then(()=>{this.onSuccess&&this.onSuccess()}).catch(t=>{this.onError&&this.onError(t)})}jsonToXLS(t){let e="<thead><tr>";if(this.title&&this.title.length){for(let t of this.title)e+=`<th colspan=${t.colspan}>${t.name}`;e+="<th></tr>"}for(let o in t[0])e+="<th>"+o+"</th>";if(e+="</tr></thead><tbody>",t.map(t=>{for(let o in e+="<tbody><tr>",t)e+=`<td>${t[o]}</td>`;e+="</tr></tbody>"}),this.footer&&this.footer.length){for(let t of(e+="<tfooter><tr>",this.footer))e+=`<th colspan=${t.colspan}>${t.name}`;e+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style type="text/css">td{mso-number-format:@;}</style></head><body><table>${table}</table></body></html>'.replace("${table}",e)}jsonToCSV(t){var e="";if(this.title&&this.title.length){for(let t of this.title)e+=`${t.name}`;e+="\r\n"}for(let o in t[0])e+=o+",";if(e=e.slice(0,e.length-1)+"\r\n",t.map(t=>{for(let o in t){let r=t[o]+"";r.match(/[,"\n]/)&&(r='"'+r.replace(/\"/g,'""')+'"'),e+=r+","}e=e.slice(0,e.length-1)+"\r\n"}),this.footer&&this.footer.length){for(let t of this.footer)e+=`${t.name}`;e+="\r\n"}return e}getProcessedJson(t){let e=this.getKeys(t),o=[];return t.map(t=>{let r={};for(let o in e){let s=e[o];r[o]=this.getNestedData(s,t)}o.push(r)}),o}getKeys(t){let e={};for(let o in t[0])e[o]=o;return e}getNestedData(t,e){var o;let r=s(t)?t.field:t,n=null,l=`${r}`.split(".");n=e[l[0]];for(let t=1;t<l.length;t++)n=n[l[t]];return void 0!==(o=n=this.callItemCallback(t,n))&&null!==o?n:""}callItemCallback(t,e){return s(t)&&"function"==typeof t.callback?t.callback(e):e}base64ToBlob(t,e){let o=window.btoa(window.unescape(encodeURIComponent(t))),r=window.atob(o),s=r.length,n=new Uint8ClampedArray(s);for(;s--;)n[s]=r.charCodeAt(s);return new Blob([n],{type:e})}}return e})());
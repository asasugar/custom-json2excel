((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).customJson2excel=e()})(this,function(){let o=Object.prototype.toString;function r(t){return null!==t&&(t=t,e="Object",o.call(t)===`[object ${e}]`);var e}return class{constructor({data:t=[],scope:e={},orderedKey:o=[],filters:s=[],title:r=[],footer:n=[],keyMap:i={},name:a="excel",type:l="xls",onStart:h=()=>{},onSuccess:c=()=>{},onError:f=t=>{console.log(t)}}){this.data=t,this.scope=e,this.filters=s,this.footer=n,this.orderedKey=o,this.keyMap=i,this.name=a,this.title=r,this.type=l,this.onStart=h,this.onSuccess=c,this.onError=f}generate(){var t;if(this.data&&this.data.length)return this.onStart&&this.onStart(),t=this.getProcessedJson(this.data),t=this.toChsKeys(t),"csv"==this.type?this.export(this.jsonToCSV(t),this.name+"."+this.type,"application/csv"):this.export(this.jsonToXLS(t),this.name+"."+this.type,"application/vnd.ms-excel");this.onError&&this.onError()}getObjLastValue(t,e){var o,s;return r(e)?(o=Object.keys(e)[0],s=Object.values(e)[0],this.getObjLastValue(t[o],s)):t[e]}toChsKeys(t){return t.map(t=>{var e={};if(this.orderedKey&&this.orderedKey.length)for(var o of this.orderedKey)e[o]=t[o];if(this.filters&&this.filters.length)for(var s of this.filters)delete e[s];if(this.scope&&Object.keys(this.scope).length){var r,n=Object.keys(e).length?e:t;for(r in n)this.scope.hasOwnProperty(r)?e[r]=this.getObjLastValue(n[r],this.scope[r]):e[r]=n[r]}if(this.keyMap&&Object.keys(this.keyMap).length){var i,a=Object.keys(e).length?e:t;for(i in a)this.keyMap.hasOwnProperty(i)&&(e[this.keyMap[i]]=a[i],delete a[i])}return Object.keys(e).length?e:t})}download(e,o){if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,o);else{let t=document.createElement("a");e=window.URL.createObjectURL(e);t.href=e,t.setAttribute("download",o),t.innerHTML="downloading...",t.style.display="none",document.body.appendChild(t),setTimeout(()=>{t.click(),document.body.removeChild(t),setTimeout(()=>{self.URL.revokeObjectURL(t.href)},250)},66)}}export(o,s,r){new Promise(t=>{var e=this.base64ToBlob(o,r);t(this.download(e,s))}).then(()=>{this.onSuccess&&this.onSuccess()}).catch(t=>{this.onError&&this.onError(t)})}jsonToXLS(t){let o="<thead><tr>";if(this.title&&this.title.length){for(var e of this.title)o+=`<th colspan=${e.colspan}>`+e.name;o+="<th></tr>"}for(var s in t[0])o+="<th>"+s+"</th>";if(o=o+"</tr></thead>"+"<tbody>",t.map(t=>{for(var e in o+="<tbody><tr>",t)o+=`<td>${t[e]}</td>`;o+="</tr></tbody>"}),this.footer&&this.footer.length){o+="<tfooter><tr>";for(var r of this.footer)o+=`<th colspan=${r.colspan}>`+r.name;o+="<th></tr></tr></tfooter>"}return'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style type="text/css">td{mso-number-format:@;}</style></head><body><table>${table}</table></body></html>'.replace("${table}",o)}jsonToCSV(t){var e,s="";if(this.title&&this.title.length){for(var o of this.title)s+=""+o.name;s+="\r\n"}for(e in t[0])s+=e+",";if(s=s.slice(0,s.length-1),s+="\r\n",t.map(e=>{for(var o in e){let t=e[o]+"";t.match(/[,"\n]/)&&(t='"'+t.replace(/\"/g,'""')+'"'),s+=t+","}s=s.slice(0,s.length-1),s+="\r\n"}),this.footer&&this.footer.length){for(var r of this.footer)s+=""+r.name;s+="\r\n"}return s}getProcessedJson(t){let r=this.getKeys(t),n=[];return t.map(t=>{var e,o={};for(e in r){var s=r[e];o[e]=this.getNestedData(s,t)}n.push(o)}),n}getKeys(t){var e,o={};for(e in t[0])o[e]=e;return o}getNestedData(t,e){let o=null;var s=(""+(r(t)?t.field:t)).split(".");o=e[s[0]];for(let t=1;t<s.length;t++)o=o[s[t]];return o=this.callItemCallback(t,o),o=null==o?"":o}callItemCallback(t,e){return r(t)&&"function"==typeof t.callback?t.callback(e):e}base64ToBlob(t,e){var t=window.btoa(window.unescape(encodeURIComponent(t))),o=window.atob(t);let s=o.length;for(var r=new Uint8ClampedArray(s);s--;)r[s]=o.charCodeAt(s);return new Blob([r],{type:e})}}});
